<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <title>Phone Book</title>
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <style>
        .error{
            font-size: 0.8em;
            border: 1px solid;
            margin: 10px 0px;
            padding:15px 10px 15px 8px;
            text-align:center;
            color: #D8000C;
            background-color: #FFBABA;
        }
    </style>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){

            document.addEventListener("deviceready", onDeviceReady, false);
            //window.openDatabase("databasename", "<version>", "<display_name>",'<size>');
            var db = window.openDatabase("Database", "1.0", "MyContactsDB", 200000);
            function onDeviceReady(){
                db.transaction(populateDB, errorDatabase, successCB);//Populate the database
                document.addEventListener('backbutton', onBack, false);//Override the back button functionality
            }
            function onBack(){
            //If the current page is index page then exit other wise navigate to index page
                if($.mobile.activePage.is('#index')){
                    navigator.app.exitApp();
                }else{
                    db.transaction(queryDB, errorDatabase);
                }
            } 
            function populateDB(tx){
                //Create the table
                tx.executeSql('CREATE TABLE IF NOT EXISTS MyContacts (id INTEGER PRIMARY KEY AUTOINCREMENT, \
                            name TEXT NOT NULL, nickName TEXT, mobilePhoneNumber INT, \
                            workPhoneNumber INT, emailId TEXT, website TEXT, happyBirthDay TEXT)\
                             ');
                tx.executeSql('SELECT id, name, nickName FROM MyContacts ORDER BY name', [], querySuccess, errorDatabase);
            }
 
            function successCB(){
                db.transaction(queryDB, errorDatabase);
            }
 
            function queryDB(tx){
                tx.executeSql('SELECT id, name, nickName FROM MyContacts ORDER BY name', [], querySuccess, errorDatabase);
            }
 
            function querySuccess(tx, results){
                $.mobile.showPageLoadingMsg(true);
                var len = results.rows.length;
                $("#userList").html('');
                    for (var i=0; i<len; i++){
                        var row= results.rows.item(i);
                        var htmlData = '<li id="'+row["id"]+'"><a href="#"><h2>'+row["name"]+'</h2><p class="ui-li-aside">'+row["nickName"]+'</p></a></li>';
                        //$("#userList").append(htmlData).listview('refresh');
                        $("#userList").append(htmlData);
                        $("#userList").listview().listview('refresh');
                }
                //$.mobile.changePage($("#index"), { transition : "slide"});
                $.mobile.hidePageLoadingMsg();
                $.mobile.changePage($("#index"));
            }
 
            function errorDatabase(err){
            }

            $("#addNewPage .error").html('').hide();
            $(".addNew").bind ("click", function (event){
                $("#addNewPage .error").html('').hide();
                $.mobile.changePage ($("#addNewPage"), { transition : "slide", reverse : true });
                $("#addNewPageHeader").html("Add New");
            });

            $("#save").bind ("click", function (event){
                var name = $.trim($("#name").val()).replace(/[^A-Za-z0-9 ]/g, '');
                var nickName = $.trim($("#nickName").val()).replace(/[^A-Za-z0-9 @]/g, '');
                var mobilePhoneNumber = $.trim($("#mobilePhoneNumber").val()).replace(/[^0-9-]/g, '');
                var workPhoneNumber = $.trim($("#workPhoneNumber").val()).replace(/[^0-9-]/g, '');
                var emailId = $.trim($("#emailId").val());
                var website = $.trim($("#website").val());
                var happyBirthDay = $.trim($("#happyBirthDay").val());
                console.log(name+' '+nickName+' '+mobilePhoneNumber+' '+workPhoneNumber+' '+emailId+' '+website+' '+happyBirthDay);
 
                if (name == ''){
                    $("#addNewPage .error").html('Please enter name.').show();
                }
                else{
                    resetForm();
 
                    var id = $("#id").val();
                    $("#id").val('');
                    if (id == ''){  //Save
                        db.transaction(function (tx){ tx.executeSql("INSERT INTO MyContacts (name, nickName, mobilePhoneNumber, workPhoneNumber, emailId, website, happyBirthDay) VALUES  (?, ?, ?, ?, ?, ?, ?)",[name, nickName, mobilePhoneNumber, workPhoneNumber, emailId, website, happyBirthDay],
                            queryDB, errorDatabase); });  
                    }
                    else{   //Update
                            db.transaction(function (tx){ tx.executeSql("UPDATE MyContacts SET name=?, nickName=?, mobilePhoneNumber=?, workPhoneNumber=?, emailId=?, website=?, happyBirthDay=? WHERE id=? ",[name, nickName, mobilePhoneNumber, workPhoneNumber, emailId, website, happyBirthDay, id],
                            queryDB, errorDatabase); });  
                        }
                    db.transaction(queryDB, errorDatabase);
                    }
                });
                 
                $(".refresh").bind("click", function (event){
                    db.transaction(queryDB, errorDatabase);
                });
                 
                $(".back").bind("click", function (event){
                    resetForm();
                    db.transaction(queryDB, errorDatabase);
                });
                 
                function resetForm(){
                    $("#addNewPage .error").html('').hide();
                    $("#addNewPage #name").val('');
                    $("#addNewPage #nickName").val('');
                    $("#addNewPage #mobilePhoneNumber").val('');
                    $("#addNewPage #workPhoneNumber").val('');
                    $("#addNewPage #emailId").val('');
                    $("#addNewPage #website").val('');
                    $("#addNewPage #happyBirthDay").val('');
                    $("#addNewPage #addNewPageHeader").html('');    
                }
        });
    </script>
</head>
<body>
        <!-- main page starts -->
        <div data-role="page" id="index">
            <div data-role="header" data-position="fixed">
                <a href="#" class="refresh" data-icon="refresh" data-theme="a" title="Refresh">Refresh</a>
                <h1>My Contacts</h1>
                <a href="#" class="addNew" data-icon="add" data-theme="a" title="Add New">Add</a>
            </div>
            <div data-role="content">
                <ul data-role="listview" id="userList">  </ul>
            </div>
            <div data-role="popup" id="actionList-popup" data-overlay-theme="a">
                <ul data-role="listview" id="actionList" style="border: 1px solid blue; width:15em">
                </ul>
            </div>
            <input type="hidden" id="tapHoldCheck" value="" />
        </div>
        <!-- main page ends -->

        <!-- add contact form starts -->
        <div data-role="page" id="addNewPage">
            <div data-role="header" data-position="fixed">
                <a href="#" class="back" data-role="button" data-icon="arrow-l" data-theme="a" title="Back">Back</a>
                <h1 id="addNewPageHeader"></h1>
                <a href="#" id="save" data-role="button" data-icon="check" data-theme="a" title="Save">Save</a>
            </div>
            <div data-role="content">
                <div class='error'></div>
                <div data-role="fieldcontain">
                    <label for="name">Name</label>
                    <input type="text" name="name" id="name" required="true" maxlength="100" value="" />
                </div>
                <div data-role="fieldcontain">
                    <label for="nickName">Nick Name</label>
                    <input type="text" name="nickName" id="nickName" maxlength="100" value="" />
                </div>
                <div data-role="fieldcontain">
                    <label for="mobilePhoneNumber">Mobile Number</label>
                    <input type="tel" name="mobilePhoneNumber" id="mobilePhoneNumber" maxlength="15" value="" />
                </div>
                <div data-role="fieldcontain">
                    <label for="workPhoneNumber">Work Phone Number</label>
                    <input type="tel" name="workPhoneNumber" id="workPhoneNumber" maxlength="15" value="" />
                </div>
                <div data-role="fieldcontain">
                    <label for="emailId">Email Id</label>
                    <input type="email" name="emailId" id="emailId" maxlength="100" value="" />
                </div>
                <div data-role="fieldcontain">
                    <label for="website">Website</label>
                    <input type="url" name="website" id="website" maxlength="100" value="" />
                </div>
                <div data-role="fieldcontain">
                    <label for="happyBirthDay">Happy Birth Day</label>
                    <input type="date" name="happyBirthDay" id="happyBirthDay" value="" />
                </div>
                <input type="hidden" name="id" id="id" value="" />
            </div>
        </div>
        <!-- add contact form ends -->
</body>
</html>